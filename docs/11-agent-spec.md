# Agent Specification

Lightweight agent running on managed servers for metrics and status reporting.

---

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Agent role | Metrics + status only | Keep it simple, SSH for commands |
| Communication | Agent → Panel (push) | No inbound ports needed except health |
| Implementation | Docker container | Easy install, isolated, auto-restart |
| Language | Go binary in container | Single binary, low resource, fast startup |

**What agent does:**
- Sends heartbeat every 60 seconds
- Reports CPU, RAM, disk metrics
- Reports Docker container statuses
- Responds to health checks

**What agent does NOT do:**
- Execute commands (SSH handles this)
- Deploy apps (panel does via SSH)
- Manage Caddy (panel does via SSH)

---

## Agent Architecture

```
┌─────────────────────────────────────────┐
│ Managed Server                          │
│                                         │
│  ┌─────────────┐    ┌────────────────┐ │
│  │ UPanel Agent│    │ Docker         │ │
│  │ (container) │───▶│ Socket         │ │
│  └──────┬──────┘    └────────────────┘ │
│         │                               │
│         │ HTTPS POST                    │
│         ▼                               │
└─────────────────────────────────────────┘
          │
          │ Heartbeat every 60s
          ▼
┌─────────────────────────────────────────┐
│ UPanel (your infrastructure)            │
│                                         │
│  POST /api/agent/heartbeat              │
│  Authorization: Bearer {agent_token}    │
│                                         │
└─────────────────────────────────────────┘
```

---

## Agent API (Agent → Panel)

### Heartbeat

```
POST /api/agent/heartbeat
Authorization: Bearer {agent_token}
Content-Type: application/json

{
    "server_id": "01HQXYZ...",
    "timestamp": "2024-01-15T10:30:00Z",
    "metrics": {
        "cpu_percent": 23.5,
        "ram_used_mb": 1024,
        "ram_total_mb": 4096,
        "disk_used_gb": 45,
        "disk_total_gb": 100,
        "load_average": [0.5, 0.4, 0.3],
        "network_in_bytes": 123456789,
        "network_out_bytes": 987654321
    },
    "containers": [
        {
            "id": "abc123",
            "name": "myapp_web_1",
            "image": "myapp:latest",
            "status": "running",
            "health": "healthy",
            "uptime_seconds": 86400,
            "cpu_percent": 5.2,
            "memory_mb": 256
        },
        {
            "id": "def456",
            "name": "myapp_db_1",
            "image": "postgres:16",
            "status": "running",
            "health": "healthy",
            "uptime_seconds": 86400,
            "cpu_percent": 2.1,
            "memory_mb": 512
        }
    ],
    "agent_version": "1.0.0"
}
```

**Response:**

```json
{
    "status": "ok",
    "server_time": "2024-01-15T10:30:01Z",
    "next_heartbeat_seconds": 60
}
```

### Registration (One-time)

Called by install script to confirm agent is running:

```
POST /api/agent/register
Authorization: Bearer {install_token}
Content-Type: application/json

{
    "hostname": "prod-server-1",
    "os_version": "Ubuntu 24.04 LTS",
    "cpu_cores": 4,
    "ram_mb": 8192,
    "disk_gb": 100,
    "agent_version": "1.0.0"
}
```

**Response:**

```json
{
    "status": "ok",
    "server_id": "01HQXYZ...",
    "agent_token": "eyJ...",  // JWT or random token
    "panel_url": "https://panel.example.com"
}
```

---

## Panel API (Panel → Agent)

Agent exposes minimal API for health checks only:

### Health Check

```
GET /health
```

**Response:**

```json
{
    "status": "ok",
    "uptime_seconds": 3600,
    "version": "1.0.0"
}
```

No authentication - just confirms agent is running.

---

## Agent Implementation

### docker-compose.yml (Agent)

```yaml
version: '3.8'

services:
  agent:
    image: ghcr.io/inte-team/upanel-agent:latest
    container_name: upanel-agent
    restart: unless-stopped
    environment:
      - PANEL_URL=${PANEL_URL}
      - AGENT_TOKEN=${AGENT_TOKEN}
      - SERVER_ID=${SERVER_ID}
      - HEARTBEAT_INTERVAL=60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    ports:
      - "8443:8443"  # Health check only
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### Agent Config (Generated by Panel)

`/opt/upanel-agent/.env`:

```env
PANEL_URL=https://panel.example.com
SERVER_ID=01HQXYZ...
AGENT_TOKEN=eyJ...
HEARTBEAT_INTERVAL=60
```

### Go Agent (Simplified)

```go
package main

import (
    "bytes"
    "encoding/json"
    "net/http"
    "os"
    "time"
    
    "github.com/docker/docker/client"
    "github.com/shirou/gopsutil/v3/cpu"
    "github.com/shirou/gopsutil/v3/disk"
    "github.com/shirou/gopsutil/v3/mem"
)

type Heartbeat struct {
    ServerID   string     `json:"server_id"`
    Timestamp  time.Time  `json:"timestamp"`
    Metrics    Metrics    `json:"metrics"`
    Containers []Container `json:"containers"`
    Version    string     `json:"agent_version"`
}

type Metrics struct {
    CPUPercent   float64 `json:"cpu_percent"`
    RAMUsedMB    uint64  `json:"ram_used_mb"`
    RAMTotalMB   uint64  `json:"ram_total_mb"`
    DiskUsedGB   uint64  `json:"disk_used_gb"`
    DiskTotalGB  uint64  `json:"disk_total_gb"`
}

type Container struct {
    ID       string  `json:"id"`
    Name     string  `json:"name"`
    Image    string  `json:"image"`
    Status   string  `json:"status"`
    CPUPct   float64 `json:"cpu_percent"`
    MemoryMB uint64  `json:"memory_mb"`
}

func main() {
    panelURL := os.Getenv("PANEL_URL")
    token := os.Getenv("AGENT_TOKEN")
    serverID := os.Getenv("SERVER_ID")
    
    // Start health server
    go startHealthServer()
    
    // Heartbeat loop
    ticker := time.NewTicker(60 * time.Second)
    for {
        sendHeartbeat(panelURL, token, serverID)
        <-ticker.C
    }
}

func sendHeartbeat(panelURL, token, serverID string) {
    heartbeat := Heartbeat{
        ServerID:   serverID,
        Timestamp:  time.Now().UTC(),
        Metrics:    collectMetrics(),
        Containers: collectContainers(),
        Version:    "1.0.0",
    }
    
    body, _ := json.Marshal(heartbeat)
    
    req, _ := http.NewRequest("POST", panelURL+"/api/agent/heartbeat", bytes.NewBuffer(body))
    req.Header.Set("Authorization", "Bearer "+token)
    req.Header.Set("Content-Type", "application/json")
    
    client := &http.Client{Timeout: 10 * time.Second}
    resp, err := client.Do(req)
    if err != nil {
        log.Printf("Heartbeat failed: %v", err)
        return
    }
    defer resp.Body.Close()
}

func collectMetrics() Metrics {
    cpuPercent, _ := cpu.Percent(time.Second, false)
    memInfo, _ := mem.VirtualMemory()
    diskInfo, _ := disk.Usage("/")
    
    return Metrics{
        CPUPercent:  cpuPercent[0],
        RAMUsedMB:   memInfo.Used / 1024 / 1024,
        RAMTotalMB:  memInfo.Total / 1024 / 1024,
        DiskUsedGB:  diskInfo.Used / 1024 / 1024 / 1024,
        DiskTotalGB: diskInfo.Total / 1024 / 1024 / 1024,
    }
}

func collectContainers() []Container {
    cli, _ := client.NewClientWithOpts(client.FromEnv)
    containers, _ := cli.ContainerList(context.Background(), types.ContainerListOptions{})
    
    var result []Container
    for _, c := range containers {
        result = append(result, Container{
            ID:     c.ID[:12],
            Name:   c.Names[0],
            Image:  c.Image,
            Status: c.State,
        })
    }
    return result
}

func startHealthServer() {
    http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request) {
        json.NewEncoder(w).Encode(map[string]string{
            "status":  "ok",
            "version": "1.0.0",
        })
    })
    http.ListenAndServe(":8443", nil)
}
```

---

## Security

### Agent Token

- Generated during server registration
- 64-character random string
- Hashed (SHA256) before storage in panel DB
- Sent with every heartbeat
- Can be rotated via panel UI

### Token Rotation

```php
// ServerController@rotateAgentToken
public function rotateAgentToken(Server $server)
{
    $newToken = Str::random(64);
    
    // Update in DB (hashed)
    $server->update([
        'agent_token' => hash('sha256', $newToken),
    ]);
    
    // SSH to server and update agent config
    $this->sshService->execute($server,
        "sed -i 's/AGENT_TOKEN=.*/AGENT_TOKEN={$newToken}/' /opt/upanel-agent/.env && " .
        "cd /opt/upanel-agent && docker compose restart"
    );
    
    return response()->json(['message' => 'Token rotated']);
}
```

### Network Security

- Agent only needs outbound HTTPS to panel
- Port 8443 only for health checks (optional, can be firewalled)
- All communication TLS encrypted
- No sensitive data in heartbeat (just metrics)

---

## Failure Handling

### Panel Unreachable

Agent continues running, queues heartbeats (up to 10), retries:

```go
var heartbeatQueue []Heartbeat

func sendHeartbeat(...) {
    // ... try to send ...
    
    if err != nil {
        if len(heartbeatQueue) < 10 {
            heartbeatQueue = append(heartbeatQueue, heartbeat)
        }
        return
    }
    
    // Success - flush queue
    for _, hb := range heartbeatQueue {
        sendSingleHeartbeat(hb)
    }
    heartbeatQueue = nil
}
```

### Agent Crash

Docker `restart: unless-stopped` handles automatic restart.

### Docker Socket Unavailable

Agent logs error, sends heartbeat without container info:

```go
containers, err := collectContainers()
if err != nil {
    log.Printf("Cannot collect containers: %v", err)
    containers = nil // Send heartbeat anyway
}
```

---

## Monitoring the Agent

### From Panel

Server detail page shows:
- Last heartbeat time
- Agent version
- Container count

### From Server

```bash
# Agent logs
docker logs upanel-agent -f

# Agent status
docker ps | grep upanel-agent

# Test heartbeat manually
curl -X POST https://panel.example.com/api/agent/heartbeat \
  -H "Authorization: Bearer $AGENT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"server_id":"...","metrics":{...}}'
```

---

## Agent Updates

### Manual Update

```bash
cd /opt/upanel-agent
docker compose pull
docker compose up -d
```

### Auto-Update (Future)

Panel can trigger update via SSH:

```php
public function updateAgent(Server $server)
{
    $this->sshService->execute($server,
        "cd /opt/upanel-agent && docker compose pull && docker compose up -d"
    );
}
```

Or agent self-updates on heartbeat response:

```json
{
    "status": "ok",
    "update_available": true,
    "update_url": "ghcr.io/inte-team/upanel-agent:1.1.0"
}
```
